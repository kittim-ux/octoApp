<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_ws_operation">
    <sys_ws_operation action="INSERT_OR_UPDATE">
        <active>true</active>
        <consumes>application/json,application/xml,text/xml</consumes>
        <consumes_customized>false</consumes_customized>
        <default_operation_uri>/api/x_938832_octomobil/elasticsearch_data/api/stn-elastdata-api</default_operation_uri>
        <enforce_acl>cf9d01d3e73003009d6247e603f6a990</enforce_acl>
        <http_method>GET</http_method>
        <name>STN Elastic Data</name>
        <operation_script><![CDATA[(function process( /*RESTAPIRequest*/ request, /*RESTAPIResponse*/ response) {
    try {
        // Define the Elasticsearch URL
        var elasticsearchUrl = "https://edde-41-209-57-166.ngrok-free.app/stnbucket/_search/?size=100";

        // Make an HTTP GET request to Elasticsearch using the sn_ws module
        var requestMessage = new sn_ws.RESTMessageV2(); // Use RESTMessageV2
        requestMessage.setEndpoint(elasticsearchUrl);
        requestMessage.setHttpMethod("get");

        // Execute the request
        var responseFromElasticsearch = requestMessage.execute();

        // Check the HTTP response status
        var statusCode = responseFromElasticsearch.getStatusCode();
        var responseBody = responseFromElasticsearch.getBody();

        if (statusCode === 200) {
            // Parse the Elasticsearch data and extract the required fields
            var parsedData = JSON.parse(responseBody);
            var hits = parsedData.hits.hits;
            var groupedData = {};

            for (var i = 0; i < hits.length; i++) {
                var hit = hits[i];
                var source = hit._source;
                var region = source.region;
                var ifDescr = source.ifDescr;
                var serialNumber = source.serialNumber;
                var building_name = source.building_name;
                var ifOperStatus = source.ifOperStatus;
                var agent_host = source.agent_host;

                // Create a grouping based on "building_name"
                if (!groupedData[building_name]) {
                    groupedData[building_name] = [];
                }

                // Rename "serialNumber" to "Serial_Code"
                var renamedData = {
                    "Serial_Code": serialNumber, // Rename the property
                    "ifOperStatus": ifOperStatus,
                };

                // Push the renamed object to the group
                groupedData[building_name].push(renamedData);
            }

            // Set the successful response
            response.setStatus(200); // OK
            response.setBody(groupedData);
        } else {
            // Handle error cases here by setting the error message as the response body
            var errorResponse = {
                "error": "Error fetching data from Elasticsearch",
                "status_code": statusCode
            };
            response.setStatus(statusCode);
            response.setBody(errorResponse);
        }
    } catch (ex) {
        // Handle exceptions
        gs.log("Exception: " + ex.toString(), "Scripted REST API Error");
        response.setStatus(500); // Internal Server Error
        response.setBody("Exception: " + ex.toString());
    }
})(request, response);
]]></operation_script>
        <operation_uri>/api/x_938832_octomobil/v1/elasticsearch_data/api/stn-elastdata-api</operation_uri>
        <produces>application/json,application/xml,text/xml</produces>
        <produces_customized>false</produces_customized>
        <relative_path>/api/stn-elastdata-api</relative_path>
        <request_example/>
        <requires_acl_authorization>true</requires_acl_authorization>
        <requires_authentication>true</requires_authentication>
        <requires_snc_internal_role>true</requires_snc_internal_role>
        <short_description/>
        <sys_class_name>sys_ws_operation</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2023-10-10 15:29:16</sys_created_on>
        <sys_id>030553a947b9351030980d45d36d43fe</sys_id>
        <sys_mod_count>50</sys_mod_count>
        <sys_name>STN Elastic Data</sys_name>
        <sys_package display_value="octoMobile" source="x_938832_octomobil">0fa9e0a32fc75110bdcc5fd92799b649</sys_package>
        <sys_policy/>
        <sys_scope display_value="octoMobile">0fa9e0a32fc75110bdcc5fd92799b649</sys_scope>
        <sys_update_name>sys_ws_operation_030553a947b9351030980d45d36d43fe</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2023-10-11 22:59:14</sys_updated_on>
        <web_service_definition display_value="ElasticSearch Data">64d0d36547b9351030980d45d36d436c</web_service_definition>
        <web_service_version display_value="v1">6794936547b9351030980d45d36d434f</web_service_version>
    </sys_ws_operation>
</record_update>
